#!/usr/bin/env python3

import requests
from requests.auth import AuthBase

class Client:
    auth_endpoint = 'https://oauth.wildapricot.org/auth/token'
    api_endpoint = 'https://api.wildapricot.org'

    def __init__(self, api_key):
        self.api_key = api_key
        data = {'grant_type': 'client_credentials', 'scope': 'auto'}
        self.authenticate(data)

    def __call__(self, path):
        auth = HTTPBearerAuth(self.token)
        pass

    def authenticate(self, data):
        response = requests.post(self.auth_endpoint, data, auth=('APIKEY', self.api_key)).json()
        self.token = response['access_token']
        self.refresh_token = response['refresh_token']

    def refresh(self):
        data = {'grant_type': 'refresh_token', 'refresh_token': self.refresh_token}
        self.authenticate(data)

class HTTPBearerAuth(AuthBase):
    def __init__(self, token):
        self.token = token

    def __eq__(self, other):
        return self.token == getattr(other, 'token', None)

    def __ne__(self, other):
        return not self == other

    def __call__(self, r):
        r.headers['Authorization'] = 'Bearer ' + self.token
        return
