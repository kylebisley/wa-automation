#!/usr/bin/env python3

from argparse import ArgumentParser
from configparser import ConfigParser
from oauthlib.oauth2 import BackendApplicationClient
from requests_oauthlib import OAuth2Session

CLIENT_ID = 'APIKEY'

# Parse command-line arguments.
parser = ArgumentParser()
parser.add_argument('-c', '--config', required = True, help = 'Path to configuration file.')
parser.add_argument('-a', '--account', help = 'Wild Apricot account ID (overrides configuration file).')
args = parser.parse_args()

# Read configuration file.
config = ConfigParser()
config.read(args.config)

client = BackendApplicationClient(client_id = CLIENT_ID)

with OAuth2Session(client = client) as session:
    token = session.fetch_token(config['server']['auth'], client_id = CLIENT_ID, client_secret = config['client']['secret'], scope = 'auto')

    if args.account:
        account = args.account
    elif 'account-id' in config['client']:
        account = config['client']['account-id']
    else:
        account = token['Permissions'][0]['AccountId']

    host = config['server']['api']
    endpoint = '/v2.1/accounts/' + str(account) + '/contacts'
    params = {'$async': False}
    response = session.get(host + endpoint, params = params)

    if not response.ok:
        print(str(response.status_code) + ':', response.reason)
        exit()

    from pprint import pprint
    pprint(response.json())
